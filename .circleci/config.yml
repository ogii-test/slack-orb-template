version: '2.1'
 
orbs:
  slack: circleci/slack@4.2.1

jobs:
  job1: 
    docker:
      - image: cimg/base:2020.01
    steps:
      - checkout
      - run:
          command: |
            echo 'export MY_ORB_TEMPLATE_PASS=$(jq .pass ./slack_template/templates.json)' >> $BASH_ENV
            echo "$MY_ORB_TEMPLATE_PASS"
      - run:
          command: |
            echo 'export MY_ORB_TEMPLATE_FAIL=$(jq .fail ./slack_template/templates.json)' >> $BASH_ENV
            echo "$MY_ORB_TEMPLATE_FAIL"
      - run:
         command: |
          ARTIFACT=$(curl -X GET https://circleci.com/api/v1.1/project/bitbucket/ispottv/qaautomationframework/1199/artifacts -H "circle-token: $CIRCLECI_TOKEN" | jq '.[0].url' )
          echo "export ARTIFACT_URL=$ARTIFACT" >> $BASH_ENV
      - run: echo "$ARTIFACT_URL"
      - slack/notify:
          channel: slacktest
          event: fail
          template: MY_ORB_TEMPLATE_PASS
      - slack/notify:
          channel: slacktest
          event: pass
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "plain_text",
                      "text": "$ARTIFACT_URL",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                      {
                          "type": "button",
                          "text": {
                              "type": "plain_text",
                              "text": "View Job",
                              "emoji": true
                          },
                          "value": "view_job",
                          "url": "$ARTIFACT_URL"
                      }
                  ]
              }
              ]
            }

workflows:
  send-notification:
    jobs:
      - job1:
          context: slack-secrets
